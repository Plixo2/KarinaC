

<div align="center">

<h1 align="center">Karina Compiler</h1>
<a href="https://karina-lang.org/">
  karina-lang.org
</a>

</div>

<br>
<br>
<br>

![Test Status](https://github.com/Plixo2/KarinaC/actions/workflows/gradle.yml/badge.svg)
![Java Version](https://img.shields.io/badge/Java-21+-orange)
![Karina Version](https://img.shields.io/badge/Karina-v0.6-8A2BE2)
![Visitors](https://visitor-badge.laobi.icu/badge?page_id=plixo.karinac)
[![License: MIT/Apache-2.0](https://img.shields.io/badge/License-Apache--2.0%20%7C%20MIT-blue)](https://opensource.org/licenses/MIT)
![Windows](https://img.shields.io/badge/Windows-0078D6?style=flat)
![Linux](https://img.shields.io/badge/Linux-FCC624?style=flat&logo=linux&logoColor=black)
![macOS](https://img.shields.io/badge/macOS-000000?style=flat&logo=apple&logoColor=white)
<br>

**Karina is a statically typed, general-purpose, high-level programming language that emphasizes simplicity, 
interoperability, and concise notation. Karina is fully compatible with Java, allowing you to use existing libraries and 
frameworks seamlessly while enjoying a modern programming experience.**

<br>

> ðŸ“¢ **Heads up!** If you run into any issues, bugs, unexpected behavior, or have any questions while using this project, youâ€™re encouraged to [open an issue](https://github.com/Plixo2/KarinaC/issues/new).
>
> Your feedback and inquiries are greatly appreciated!

<br>

## Installer and CLI

You need Java 21 or higher.
You can use [SDKMAN!](https://sdkman.io/) to manage your Java versions.


To install the Karina compiler, download and run the installer.
After the installation, you can run the compiler from the command line:

```shell
karina -v
```
> Karina: v0.6 \
> Java: OpenJDK 64-Bit Server VM 23.0.2


#### Hello World

```shell
karina new hello-world
cd hello-world
karina run
```

> Hello, World!

### Documentation

The official documentation is available at
[karina-lang.org](https://karina-lang.org/guide/hello.html).


<br>
<br>

## Getting Started with local development

You need Java 21 or higher.
You can use [SDKMAN!](https://sdkman.io/) to manage your Java versions.



```shell
 git clone https://github.com/Plixo2/KarinaC.git
 cd KarinaC
```

<details> <summary>IDE setup</summary>

The compiler is a standard Gradle project, so you can use it with any IDE that supports Gradle.

You can run the compiler via the Gradle task `run` or run the [Main Class](src/main/java/org/karina/lang/compiler/Main.java) directly.

The `--run` command-line argument can be used to run the program after compilation.


</details>

<details>

<summary>Manual setup</summary>

Make sure your `JAVA_HOME` is set to the correct version.

```shell
 gradlew run
```

</details>


The project is configured to build the demo project in [`resources/src/`](resources/src/) by default.

## Development

<details> <summary>Custom Environment</summary>


You can set System environment flags via [build.gradle](build.gradle) or the vm arguments in your IDE.

```groovy
application {
  // ...
  applicationDefaultJvmArgs = ['-Dkarina.source="resources/local/"'] // set the source folder to your local dev folder
}
```

### Flags:

#### karina.source
> `karina.source="<src folder>"`

Points to your local development folder. Defaults to `resources/src/`

#### karina.out
> `karina.out="<build file>"`

Specifies the output JAR file. Defaults to `resources/out/build.jar`

#### karina.classes
> `karina.classes="<true/false>"`

Enables/Disables the generation of .class files. Defaults to `true`

#### karina.flight
> `karina.flight="<debug file>"`

Specifies the debug flight recorder file path. Defaults to `resources/flight.txt`

#### karina.console
> `karina.console="<true/false>"`

Enables/Disables the flight recorder output to the console. Defaults to `true`

#### karina.binary
> `karina.binary="<true/false>"`

Enables/Disables the usage of a binary format for faster reading of precompiled classes.
Can improve startup performance by over 20 times, but untested and may cause issues.
Defaults to `false`



#### karina.logging

> `karina.logging="<none/basic/verbose/verbose_jvm>"`

Enables/Disables the flight recorder output to the console. Defaults to `none`.
Useful for debugging the compiler.


</details>

### Customize Logging
You can set custom log types in
[here](src/main/java/org/karina/lang/compiler/logging/Log.java#L45).

Adding log types will enable logging for specific parts of the compiler.
You can gain detailed insights into the inner workings of the compiler
by setting the correct logging types.


E.g. `LogTypes.CHECK_TYPE` will get you a **very** detailed view of the type checking process.

> [!NOTE]
> This is the primary way to debug the compiler.
> Be aware that this will generate a lot of output, when too many log types are enabled.

### javap

Another helpful tool is [`javap`](https://docs.oracle.com/en/java/javase/21/docs/specs/man/javap.html). Use it to inspect the generated bytecode in detail.

```shell
javap -c -v -p main.class > main.txt
```
This will write the bytecode of the `main.class` file to `main.txt`, where it can be inspected.


## Rebuild the standard library

You can rebuild the [standard library](src/main/java/karina/lang/) with the
Gradle task `KARINA-BASE`.

This will create a new  `karina_base.jar` file, located in [`src/main/resources`](src/main/resources)

Delete the `base.bin.gz` file in the `resources` folder to force a rebuild of the binary format when in use.


# Compiler architecture

<details open>

<summary>Internals</summary>



- Read the source code into memory
- Load the precompiled JAR files (java.core and the karina.base) into a ClassModel 
- [Parser Stage](src/main/java/org/karina/lang/compiler/stages/parser/ParseProcessor.java)
  - Parse the loaded files into tokens, then into an AST via Antlr
  - Convert the Antlr AST into a ClassModel and IR
- [Import Stage](src/main/java/org/karina/lang/compiler/stages/imports/ImportProcessor.java)
  - Resolve all types via imports
- [Attribution Stage](src/main/java/org/karina/lang/compiler/stages/attrib/AttributionProcessor.java)
  - Expression validation and type inference
- [Lower Stage](src/main/java/org/karina/lang/compiler/stages/lower/LoweringProcessor.java)
  - Construct new classes, bridge methods, rewrite loops, etc
- [Generate Stage](src/main/java/org/karina/lang/compiler/stages/generate/GenerationProcessor.java)
  - Generate bytecode
- And then finally write the bytecode to disk

#### Important classes:
- [Main Class](src/main/java/org/karina/lang/compiler/Main.java)
- [Compiler Class](src/main/java/org/karina/lang/compiler/KarinaCompiler.java)
- [KExpr Class](src/main/java/org/karina/lang/compiler/utils/KExpr.java)
- [KType Class](src/main/java/org/karina/lang/compiler/utils/KType.java)

#### Important Packages
- [jvm_loading](src/main/java/org/karina/lang/compiler/jvm_loading)
  - Responsible for loading precompiled classes
- [model_api](src/main/java/org/karina/lang/compiler/model_api)
  - The API for the ClassModel. Represents all loaded classes and their fields, methods, etc
- [stages](src/main/java/org/karina/lang/compiler/stages)
  - All stages of the compiler.

</details>







